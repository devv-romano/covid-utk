<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>COVID@UTK</title>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<header class="bg-gray-900 p-4 text-white font-bold flex justify-between items-center">
    <span>COVID@UTK</span>
    <small class="font-normal pl-4"><em>Not officially affiliated with the University of Tennessee</em></small>
</header>
<div class="p-4">
    <section title="Introduction">
        <p>This is a collection of data, links, and tips to spread awareness of COVID-19 during the Fall 2020 Semester at UTK.</p>
    </section>
    <div class="flex flex-wrap">
        <section title="New cases" class="my-4 w-full lg:w-1/3 md:w-1/2" id="new-cases">
            <h1 class="font-bold text-xl">New Cases in TN</h1>
            <canvas id="new-cases-chart"></canvas>
            <small>Source: <a class="font-bold" href="https://covidtracking.com/data">Covid Tracking Project</a></small>
        </section>
        <section title="New deaths" class="my-4 w-full lg:w-1/3 md:w-1/2" id="new-deaths">
            <h1 class="font-bold text-xl">New Deaths in TN</h1>
            <canvas id="new-deaths-chart"></canvas>
            <small>Source: <a class="font-bold" href="https://covidtracking.com/data">Covid Tracking Project</a></small>
        </section>
        <section title="Hospitalized" class="my-4 w-full lg:w-1/3 md:w-1/2" id="hospitalized">
            <h1 class="font-bold text-xl">Hospitalizations in TN</h1>
            <canvas id="hospitalized-chart"></canvas>
            <small>Source: <a class="font-bold" href="https://covidtracking.com/data">Covid Tracking Project</a></small>
        </section>
        <section title="Knox Cases" class="my-4 w-full lg:w-1/3 md:w-1/2" id="knox-cases">
            <h1 class="font-bold text-xl">Cases in Knox County</h1>
            <canvas id="knox-cases-chart"></canvas>
            <small>Source: <a class="font-bold" href="https://github.com/nytimes/covid-19-data">New York Times Covid-19 Data</a></small>
        </section>
        <section title="Knox Deaths" class="my-4 w-full lg:w-1/3 md:w-1/2" id="knox-deaths">
            <h1 class="font-bold text-xl">Deaths in Knox County</h1>
            <canvas id="knox-deaths-chart"></canvas>
            <small>Source: <a class="font-bold" href="https://github.com/nytimes/covid-19-data">New York Times Covid-19 Data</a></small>
        </section>
        <section title="UTK stats" class="my-4 w-full lg:w-1/3 md:w-1/2" id="utk-stats">
            <h1 class="font-bold text-xl">Current UTK Cases</h1>
            <canvas id="current-utk-cases-chart"></canvas>
            <div><small>Cumulative since June 8: <span class="font-bold" id="utk-cumulative-since"></span></small></div>
            <small>Source: <a class="font-bold" href="https://veoci.com/veoci/p/form/4jmds5x4jj4j#tab=entryForm">Dashboard for Temporary Space Closures</a></small>
            <small>(updated <span id="utk-stats-updated"></span>)</small>
        </section>
        <section title="More Sources" class="my-4 w-full lg:w-1/3 md:w-1/2" id="more-sources">
            <h1 class="font-bold text-xl">More sources</h1>
            <div class="flex flex-col p-4">
                <a class="italic font-bold" href="https://www.utk.edu/coronavirus/">UTK Coronavirus Updates</a>
                <a class="italic font-bold" href="https://covid.knoxcountytn.gov/case-count.html">Knox County Health Dept</a>
                <a class="italic font-bold" href="https://knoxvilletn.gov/government/mayors_office/c_o_v_i_d-19___coronavirus_/daily_case_counts">Knoxville Mayor's Office</a>
                <a class="italic font-bold" href="https://www.tn.gov/health/cedep/ncov/data.html">Tennessee Health Dept</a>
                <a class="italic font-bold" href="https://www.cdc.gov/coronavirus/2019-ncov/prevent-getting-sick/prevention.html">CDC Prevention Guidelines</a>
                <a class="italic font-bold" href="https://www.cdc.gov/coronavirus/2019-ncov/index.html">CDC Symptom Checker</a>
            </div>
        </section>
    </div>
    <footer class="border-t my-5 flex flex-col items-end">
        <small class="inline-block text-right my-2">Made with â™¥ by Nick Romano (@nromanodev)</small>
        <small class="font-bold inline-block text-right mb-2"><a href="https://github.com/njromano/covid-utk">View source code</a></small>
        <small class="font-bold inline-block text-right mb-2"><a href="https://forms.gle/aopZKVgn12NgfMj19">Join beta email list</a></small>
        <small class="font-bold inline-block text-right mb-2"><a href="https://www.buymeacoffee.com/nromano">Buy me a coffee</a></small>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script>
        let data = [];
        let dates = [];
        let deaths = [];
        let deathsIncrease = [];
        let hospitalizedCurrently = [];
        let positiveCases = [];
        let positiveIncrease = [];
        fetch('https://covidtracking.com/api/v1/states/tn/daily.json')
        .then(r => r.json().then(json => data = json.reverse()))
        .then(() => console.log(data))
        .then(() => {
            dates = data.map(d => d.date);
            deaths = data.map(d => d.death);
            deathsIncrease = data.map(d => d.deathIncrease);
            hospitalizedCurrently = data.map(d => d.hospitalizedCurrently);
            positiveCases = data.map(d => d.positive);
            positiveIncrease = data.map(d => d.positiveIncrease);
        })
        .then(() => {
            initChart({
                id: 'new-cases-chart',
                dates,
                data: positiveIncrease,
                label: 'Daily new cases in TN',
                color: 'orange'
            });
            initChart({
                id: 'new-deaths-chart',
                dates,
                data: deathsIncrease,
                label: 'Daily new deaths in TN',
                color: 'red'
            });
            initChart({
                id: 'hospitalized-chart',
                dates,
                data: hospitalizedCurrently,
                label: 'Daily hospitalization in TN',
                color: 'blue'
            });

        })

        function initChart({id, dates, data, label, color}) {
            let ctx = document.getElementById(id).getContext('2d');
            let myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        }

        const url = "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv";
        let csv = '';
        let knoxRows = [];
        fetch(url)
        .then(r => r.text().then(text => csv = text))
        .then(() => {
            let rows = csv.split('\n').filter(row => row.includes('Knox,Tennessee'));
            rows = rows.map(row => {
                const parts = row.split(',');
                console.log(parts);
                return {
                    date: parts[0],
                    cases: parts[4],
                    deaths: parts[5]
                };
            })
            knoxRows = rows;
        })
        .then(() => {
            const dates = knoxRows.map(row => row.date);
            const cases = knoxRows.map(row => row.cases);
            const deaths = knoxRows.map(row => row.deaths);
            initChart({
                id: 'knox-cases-chart',
                dates,
                data: cases,
                label: 'Cumulative cases in Knox County',
                color: 'orange'
            });
            initChart({
                id: 'knox-deaths-chart',
                dates,
                data: deaths,
                label: 'Cumulative deaths in Knox County',
                color: 'red'
            });
        });

        // https://veoci.com/veoci/p/form/4jmds5x4jj4j#tab=entryForm
        // updating manually for now
        const utkCovidCases = {
          students: 18,
          faculty: 2,
          staff: 7,
          cumulativeSinceJune8: 85,
          updated: '7/28/20'
        }

        document.getElementById('utk-stats-updated').textContent = utkCovidCases.updated;
        document.getElementById('utk-cumulative-since').textContent = utkCovidCases.cumulativeSinceJune8;
        let ctx = document.getElementById('current-utk-cases-chart').getContext('2d');
        let utkChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Students', 'Staff', 'Faculty'],
            datasets: [{
              label: 'Active cases',
              data: [utkCovidCases.students, utkCovidCases.faculty, utkCovidCases.faculty],
              backgroundColor: ['orange', 'blue', 'gray'],
            }]
          },
          options: {
            scales: {
              yAxes: [{
                ticks: {
                  beginAtZero: true
                }
              }]
            }
          }
        });
    </script>
</div>
</body>
</html>